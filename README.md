# Game Cloud Save
This repository is a simple serverless backend for managing game save files.
It is implemented using [Amazon Web Service (AWS)][url-aws] and [Serverless Framework][url-serverless].
All cloud scripts are written in [TypeScript][url-typescript].

The followings are the AWS services used for this project:
- [Lambda][url-aws-lambda]
- [DynamoDB][url-aws-dyanmodb]
- [S3][url-aws-s3]
- [Cognito][url-aws-cognito]
- [API Gateway][url-aws-api-gateway]
- [CloudFormation][url-aws-cloudformation]

## Deployment Instructions
### Prerequisite
1. Install the followings:

| Software / Framework                            | Version |
|-------------------------------------------------|:-------:|
| [Node.js][url-nodejs]                           |  18.x   |
| [AWS Command Line Interface (CLI)][url-aws-cli] |   2.x   |

2. Setup an AWS profile for deployment through AWS CLI.

```shell
aws configure --profile gameCloudSave
```

3. Run the following commands to install all required packages from project root:

```shell
npm install

cd apigateway
npm install

cd ../lambda
npm install
```

### Steps
Run the following commands to deploy all resources to AWS from project root.  
All resources will be deployed to `us-east-1` and `dev` stage by default.
If you wish to deploy to different region, please change `region` to target region in [config.yml][path-config-yml].
If you wish to deploy to different stage, please add the target stage to `stages` in [config.yml][path-config-yml], and add `--stage <Target stage>` option after `serverless deploy`.

```shell
cd s3
serverless deploy

cd ../dynamodb
serverless deploy

cd ../cognito
serverless deploy

cd ../apigateway
serverless deploy

cd ../lambda
serverless deploy
```

## Usage
- [Authentication][session-authentication]
  - [User Registration][session-user-registration]
  - [User Authentication][session-user-authentication]
  - [Reset Password][session-reset-password]
- [User Management][session-user-management]
  - [Change Password][session-change-password]
- [Game Management][session-game-management]
  - [Get All Games][session-get-all-games]
  - [Add Game][session-add-game]
  - [Update Game][session-update-game]
- [Cloud Save Management][session-cloud-save-management]
  - [Get All Cloud Saves][session-get-all-cloud-saves]
  - [Upload Cloud Save][session-upload-cloud-save]
  - [Download Cloud Save][session-download-cloud-save]

### Authentication
#### User Registration
##### Step 1
Send a **POST** request to `/authService/registerUser` with the following payload in JSON to register new user:

| Field Name |   Type   | Description                                      |
|------------|:--------:|--------------------------------------------------|
| `username` |  string  | Email address                                    |
| `password` |  string  | [Password][session-password-default-requirement] |

###### Password Default Requirement
- At least 8 characters in length
- Include at least an upper-case character
- Include at least a lower-case character
- Include at least a number

Please update the password requirement in `PasswordPolicy` in [cognito/serverless.yml][path-cognito-serverless-yml] if necessary.

A response with status **200** will be received if user registration is successful, and a verification email with a confirmation code will be sent to the registered email address.

##### Step 2
Send a **POST** request to `/authService/confirmUserRegistration` with the following payload in JSON to confirm the user registration by using the confirmation code received in previous step:

| Field Name         |   Type   | Description                |
|--------------------|:--------:|----------------------------|
| `username`         |  string  | Email address              |
| `confirmationCode` |  string  | Confirmation code received |

A response with status **200** will be received if user registration is successfully confirmed.

#### User Authentication
Send a **POST** request to `/authService/userAuth` with the following payload in JSON to login and retrieve access token for the `Authorization` header of all other requests:

| Field Name |   Type   | Description                                      |
|------------|:--------:|--------------------------------------------------|
| `username` |  string  | Email address                                    |
| `password` |  string  | [Password][session-password-default-requirement] |

The following body in JSON will be returned if login is successful:

| Field Name    |   Type   | Description                               |
|---------------|:--------:|-------------------------------------------|
| `accessToken` |  string  | Java Web Token (JWT) generated by Cognito |
| `expireAt`    |  number  | Expiry time in UNIX timestamp             |

#### Reset Password
##### Step 1
Send a **POST** request to `/authService/resetPassword` with the following payload in JSON to request password reset:

| Field Name |   Type   | Description   |
|------------|:--------:|---------------|
| `username` |  string  | Email address |

A response with status **200** will be received if password reset request is successful, and a verification email with a confirmation code will be sent to the email address.

##### Step 2
Send a **POST** request to `/authService/confirmPasswordReset` with the following payload in JSON to confirm the password reset by using the confirmation code received in previous step:

| Field Name         |   Type   | Description                                          |
|--------------------|:--------:|------------------------------------------------------|
| `username`         |  string  | Email address                                        |
| `password`         |  string  | New [password][session-password-default-requirement] |
| `confirmationCode` |  string  | Confirmation code received                           |

A response with status **200** will be received if password reset is successfully confirmed.

### User Management
_For all following requests, the `accessToken` received from [user authentication][session-user-authentication] must be provided in the `Authorization` header of the request._

#### Change Password
Send a **POST** request to `/userService/changePassword` with the following payload in JSON to change password:

| Field Name         |   Type   | Description                                          |
|--------------------|:--------:|------------------------------------------------------|
| `oldPassword`      |  string  | Old [password][session-password-default-requirement] |
| `newPassword`      |  string  | New [password][session-password-default-requirement] |

A response with status **200** will be received if changing password is successful.

### Game Management
_For all following requests, the `accessToken` received from [user authentication][session-user-authentication] must be provided in the `Authorization` header of the request._

#### Get All Games
Send a **POST** request to `/gameService/getAllGames` to retrieve all added games.

An array of [game records][session-game-record-format] will be returned.

##### Game Record Format

| Field Name |   Type   | Description               |
|------------|:--------:|---------------------------|
| `gameId`   |  string  | Unique identifier of game |
| `name`     |  string  | Game name                 |

#### Add Game
Send a **POST** request to `/gameService/addGame` with the following payload in JSON to add a new game:

| Field Name |   Type   | Description |
|------------|:--------:|-------------|
| `gameName` |  string  | Game name   |

A new [game record][session-game-record-format] will be returned:

#### Update Game
Send a **POST** request to `/gameService/updateGame` with the following payload in JSON to update game details:

| Field Name |  Type   | Description               |
|------------|:-------:|---------------------------|
| `gameId`   | string  | Unique identifier of game |
| `name`     | string  | New game name             |

A updated [game record][session-game-record-format] will be returned.

### Cloud Save Management
_For all following requests, the `accessToken` received from [user authentication][session-user-authentication] must be provided in the `Authorization` header of the request._

#### Get All Cloud Saves
Send a **POST** request to `/cloudSaveService/getAllCloudSaves` with the following payload in JSON to retrieve all cloud saves of specific game:

| Field Name |   Type   | Description               |
|------------|:--------:|---------------------------|
| `gameId`   |  string  | Unique identifier of game |

An array of [cloud save records][session-cloud-save-record-format] will be returned.

##### Cloud Save Record Format

| Field Name         |   Type   | Description                                                   |
|--------------------|:--------:|---------------------------------------------------------------|
| `gameId`           |  string  | Unique identifier of game                                     |
| `platform`         |  number  | [Platform index][session-platform-index-values]               |
| `version`          |  string  | Game version                                                  |
| `saveFiles`        |  Array   | Array of [save file records][session-save-file-record-format] |
| `cloudStoragePath` |  string  | Storage path of cloud save in S3                              |
| `createdAt`        |  number  | Record creation time in UNIX timestamp                        |

###### Platform Index Values

|  Value  | Platform |
|:-------:|----------|
|    0    | Windows  |
|    1    | Mac      |

###### Save File Record Format

| Field Name |   Type   | Description                                                 |
|------------|:--------:|-------------------------------------------------------------|
| `root`     |  number  | [Save file root index][session-save-file-root-index-values] |
| `filePath` |  string  | Save file path from root                                    |

###### Save File Root Index Values

| Value | Save File Root                     |  Support Platforms  |
|:-----:|------------------------------------|:-------------------:|
|   0   | Game installation path             |         All         |
|   1   | \<User directory>/Documents        |         All         |
|   2   | \<User directory>/AppData/Local    |  Windows **ONLY**   |
|   3   | \<User directory>/AppData/LocalLow |  Windows **ONLY**   |
|   4   | \<User directory>/AppData/Roaming  |  Windows **ONLY**   |

#### Upload Cloud Save
##### Step 1
Send a **POST** request to `/cloudSaveService/requestUploadCloudSave` with the following payload in JSON to request a upload URL for uploading a zip file containing all game save related files.

| Field Name         |   Type   | Description                                                   |
|--------------------|:--------:|---------------------------------------------------------------|
| `gameId`           |  string  | Unique identifier of game                                     |
| `platform`         |  number  | [Platform index][session-platform-index-values]               |
| `version`          |  string  | Game version                                                  |
| `saveFiles`        |  Array   | Array of [save file records][session-save-file-record-format] |

The following body in JSON will be returned:

| Field Name  |   Type   | Description                                               |
|-------------|:--------:|-----------------------------------------------------------|
| `cloudSave` |  object  | New [cloud save record][session-cloud-save-record-format] |
| `uploadUrl` |  string  | URL for uploading save file                               |

##### Step 2
Send a **PUT** request to the `uploadUrl` retrieved in previous step with a zip file containing all game save related files as payload to upload cloud save.  
The `uploadUrl` will be expired in 1 minute by default. Please update `uploadCloudSaveFileUrlExpireInSecond` in [lambda/lib/cloudSave-lib.ts][path-cloud-save-lib] to adjust the expiry time if necessary.

##### Step 3
Send a **POST** request to `/cloudSaveService/completeUploadCloudSave` with the following payload in JSON to inform the completion of uploading cloud save:

| Field Name  |   Type   | Description                            |
|-------------|:--------:|----------------------------------------|
| `gameId`    |  string  | Unique identifier of game              |
| `createdAt` |  number  | Record creation time in UNIX timestamp |

The updated [cloud save record][session-cloud-save-record-format] will be returned.

#### Download Cloud Save
##### Step 1
Send a **POST** request to `/cloudSaveService/requestDownloadCloudSave` with the following payload in JSON to request for a download URL for downloading the cloud save zip file.

| Field Name  |   Type   | Description                            |
|-------------|:--------:|----------------------------------------|
| `gameId`    |  string  | Unique identifier of game              |
| `createdAt` |  number  | Record creation time in UNIX timestamp |

A download URL will be returned.

##### Step 2
Send a **GET** request to the download URL retrieved in previous step to download cloud save.  
The download URL will be expired in 5 minutes by default. Please update `downloadCloudSaveFileUrlExpireInSecond` in [lambda/lib/cloudSave-lib.ts][path-cloud-save-lib] to adjust the expiry time if necessary.

[url-aws]: https://aws.amazon.com
[url-aws-cli]: https://aws.amazon.com/cli/
[url-aws-lambda]: https://aws.amazon.com/lambda/
[url-aws-dyanmodb]: https://aws.amazon.com/dynamodb/
[url-aws-s3]: https://aws.amazon.com/s3/
[url-aws-cognito]: https://aws.amazon.com/cognito/
[url-aws-api-gateway]: https://aws.amazon.com/api-gateway/
[url-aws-cloudformation]: https://aws.amazon.com/cloudformation/
[url-serverless]: https://www.serverless.com/framework
[url-nodejs]: https://nodejs.org
[url-typescript]: https://www.typescriptlang.org
[path-config-yml]: ./config.yml
[path-cognito-serverless-yml]: ./cognito/serverless.yml
[path-cloud-save-lib]: ./lambda/lib/cloudSave-lib.ts
[session-authentication]: #authentication
[session-user-registration]: #user-registration
[session-user-authentication]: #user-authentication
[session-reset-password]: #reset-password
[session-user-management]: #user-management
[session-change-password]: #change-password
[session-game-management]: #game-management
[session-get-all-games]: #get-all-games
[session-add-game]: #add-game
[session-update-game]: #update-game
[session-cloud-save-management]: #cloud-save-management
[session-get-all-cloud-saves]: #get-all-cloud-saves
[session-upload-cloud-save]: #upload-cloud-save
[session-download-cloud-save]: #download-cloud-save
[session-password-default-requirement]: #password-default-requirement
[session-game-record-format]: #game-record-format
[session-cloud-save-record-format]: #cloud-save-record-format
[session-platform-index-values]: #platform-index-values
[session-save-file-record-format]: #save-file-record-format
[session-save-file-root-index-values]: #save-file-root-index-values